{% load static %}
{% load pwa %}
<!DOCTYPE html>
<html lang="en">
<head>
    {% progressive_web_app_meta %}
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
    <link rel="stylesheet" href="{% static 'queueing/css/style.css' %}" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <title>{% block title %}My amazing site{% endblock %}</title>
</head>

<body>
    <div id="content">
        {% comment %} white text in upper right of page {% endcomment %}
        <div id="header">
            {% comment %} if request.session.listener is present, display some text {% endcomment %}
            {% block header %}
                {% if request.session.listener %}
                    <h1>You Are Tuned Into <a href="{% url 'auth' request.session.listener %}">{{ request.session.listener }}</a>'s Spotify</h1>
                {% endif %}
                {% comment %} if request.session.listener is not present, display some text {% endcomment %}
                {% if not request.session.listener %}
                <h1>Start listening! Choose a DJ. {{ request.session.listener }}</h1>
                {% endif %}
            {% endblock %}
            
        </div>
        {% block content %}{% endblock %}
    </div>
</body>
<script>
    $(document).ready(function(){
        $("#header").hide();
        $("#content").hide();
        $("#header").fadeIn(1000);
        $("#content").fadeIn(1000);
        $("#shuffle").click(function(){
            $.ajax({
                url: "/shuffle/",
                headers: {'X-CSRFToken': '{{ csrf_token }}'},
                type: "GET",
                success: function(data){
                    console.log(data);
                }
            });
        });
        $("#invite").click(function(){
            // copy the link to the clipboard
            let link = document.getElementById("invite-link").value;
            // if there are spaces, make url safe
            if (link.indexOf(" ") > -1) {
                link = link.replace(/ /g, "%20");
            }
            
            navigator.clipboard.writeText(link).then(function() {
                console.log('Async: Copying to clipboard was successful!');
            }, function(err) {
            console.error('Async: Could not copy text: ', err);
            });
            // display a success message on the html page
            $("#invite-success").show();
        });
        // INSTALLATION
        // Initialize deferredPrompt for use later to show browser install prompt.
        var deferredPrompt;

        window.addEventListener('beforeinstallprompt', (e) => {
            // Prevent the mini-infobar from appearing on mobile
            e.preventDefault();
            // Stash the event so it can be triggered later.
            deferredPrompt = e;
            // Optionally, send analytics event that PWA install promo was shown.
            console.log(`'beforeinstallprompt' event was fired.`);
        });
        let buttonInstall = document.getElementById('install-btn');
        buttonInstall.addEventListener('click', async () => {
            // Show the install prompt
            try {
                deferredPrompt.prompt();
            }
            catch(err) {
                console.log(err);
                // show install-error message on html page
                console.log(navigator.platform, 'Platform')
                if (['iPhone', 'iPad', 'iPod'].includes(navigator.platform)) {
                    $("#iphone-error").show();
                }
                else {
                    $("#install-error").show();
                }
            }
            
            // Wait for the user to respond to the prompt
            const { outcome } = await deferredPrompt.userChoice;
            // Optionally, send analytics event with outcome of user choice
            console.log(`User response to the install prompt: ${outcome}`);
            // We've used the prompt, and can't use it again, throw it away
            deferredPrompt = null;
        });
    });
    
</script>
</html>